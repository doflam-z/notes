# 薪酬搜索重构

### 问题：

#### 一、有多少搜索依赖于薪酬搜索的索引？

- [x] 薪酬搜索 （数据源来自职位抓取表）
- [x] 公司薪酬搜索 (公司搜索实际上就是调用薪酬搜索)
- [ ] 职位趋势-历年薪酬、历年职位量 （历年薪酬使用的是PerYearSalaryElasticSearch数据源）
- [ ] 历年薪酬排行榜 （数据来自SalaryRankElasticSearch，索引每半年更新一次，数据源来自PositionSnatchHistoryDB）

#### 二、薪酬搜索索引数据源是哪？怎么跑的索引？

数据源来自职位抓取职位历史表

#### 三、可以合并的搜索有哪些？

##### PerYearSalaryElasticSearch（历年平均薪酬）

###### 功能：

> 1. 获取历年职位量，可以按月查询
> 2. 获取历年薪酬，可以按月

###### 字段：

> CID（公司id）	Degree（学历）	FSalary（薪酬）	Industry（行业）	PCity（城市）	PID（职位id）	PName（职位名）	PSalary（格式化后薪酬）	SCity	month	year

###### 列子：

```shell
{
        "_index": "trends2022_v2",
        "_type": "trends",
        "_id": "1641010097824",
        "_score": 1,
        "_source": {
          "PID": 233921642,
          "CID": 1236,
          "PName": "TEG03-编译器开发工程师 专家",
          "PCity": "北京",
          "PSalary": 39999,
          "month": 202201,
          "year": 2022,
          "Degree": "本科",
          "Industry": "",
          "SCity": "",
          "FSalary": "30K-50K"
        }
```

##### SalaryRankElasticSearch（薪酬排行榜）

###### 字段： 

> avgPay（平均薪酬）	city	companyCity	companyID	industry	lt	pay	positionID	year

###### 例子：

```shell
{
        "_index": "jobui_salary_rank_v1",
        "_type": "salary",
        "_id": "18_12_194073408_7",
        "_score": 1,
        "_source": {
          "companyID": "15110",
          "positionID": "194073408",
          "pay": "6000-7999",
          "avgPay": 6500,
          "city": "",
          "companyCity": "深圳",
          "industry": "电",
          "lt": "1544113987",
          "year": 2018
        }
```

##### SalarySearch（薪酬搜索 近一年平均薪酬）

###### 字段：

> keyword（职位名）	area（地区名称,中文）	cid（公司id）	jobType（职位类型）	jobAge（经验）	degree（学历）	staticField（聚类）	perPage

###### 功能：

> 1. 获取近一年平均薪资
> 2. 获取薪酬区间

###### 例子：

```shell
Array
(
    [average] => 20540
    [formatAverage] => 20.5K
    [total] => 15536
    [jobType] => Array
        (
            [0] => Array
                (
                    [name] => 不限职位
                    [salary] => 20130
                    [num] => 14352
                )

        )

    [worklen] => Array
        (
            [0] => Array
                (
                    [name] => 1-3年
                    [salary] => 14570
                    [num] => 2118
                )
        )

    [areaRanking] => Array
        (
            [0] => Array
                (
                    [name] => 广州
                    [salary] => 20540
                    [num] => 15536
                )

        )

    [job] => Array
        (
            [0] => Array
                (
                    [name] => 高级产品经理
                    [salary] => 26730
                )

            [1] => Array
                (
                    [name] => 数据产品经理
                    [salary] => 23720
                )
        )

    [degree] => Array
        (
            [0] => Array
                (
                    [name] => 博士
                    [salary] => 34170
                    [num] => 6
                )

            [1] => Array
                (
                    [name] => 硕士
                    [salary] => 23250
                    [num] => 245
                )

            [2] => Array
                (
                    [name] => 小学/初中
                    [salary] => 10500
                    [num] => 2
                )
        )

    [salaryInterval] => Array
        (
            [0] => Array
                (
                    [name] => 20K-30K
                    [salary] => 39
                )

            [1] => Array
                (
                    [name] => 15K-20K
                    [salary] => 20.6
                )

            [2] => Array
                (
                    [name] => 30K-50K
                    [salary] => 18.1
                )
        )

)
```



### 字段汇总：

| 字段名        | 注释         | 字段类型说明                 |
| :------------ | :----------- | ---------------------------- |
| PID           | 职位id       | 整数                         |
| PCity         | 工作城市     | 中文                         |
| Salary        | 薪酬         | 整数                         |
| FSalary       | 薪酬区间     | 例：30k-50k（可以写映射）    |
| SmallArea     | 小地区       | 整数                         |
| Name          | 职位名称     | 中文                         |
| PType         | 职位类别     | 例：兼职、全职（可以写映射） |
| Age           | 经验要求     | 例：1-3年 （可以写映射）     |
| Degree        | 学历要求     | 例：小学/初中（可以写映射）  |
| CID           | 公司id       | 整数                         |
| CCity         | 公司城市     | 中文                         |
| Worker        | 公司规模     | 例：100-200人（可以写映射）  |
| Industry      | 大行业       | 行业id数组                   |
| SmallIndustry | 小行业       | 小行业id数组                 |
| Month         | 最后更新月份 | 整数                         |

### 需求：

#### 一、薪酬排行榜

> 指定年份 + 地区 + 小行业

#### 二、历史薪酬搜索

> 指定年份 + 月份 + 城市 + 学历

#### 三、近一年薪酬搜索

> 1、近一年平均薪酬
>
> 2、城市聚类、薪酬区间聚类、行业聚类



### 建索引，设置别名

```shell
PUT /jobui_salary_search_2022_v2
{
    "mappings": {
        "salary": {
            "properties": {
                "PID": {
                    "type": "integer"
                },
                "Name": {
                    "type": "text",
                    "analyzer": "ik_max_word",
          					"fields": {
          						"kw": { 
            						"type":  "keyword"
          						}
        						}
                },
                "PCity": {
                    "type": "keyword"
                },
                "Salary": {
                    "type": "integer"
                },
                "FSalary": {
                    "type": "integer"
                },
                "SmallArea": {
                    "type": "keyword"
                },
                "PType": {
                    "type": "integer"
                },
                "Age": {
                    "type": "integer"
                },
                "Degree": {
                    "type": "integer"
                },
                "CID": {
                    "type": "integer"
                },
                "CCity": {
                    "type": "keyword"
                },
                "Worker": {
                    "type": "integer"
                },
                "Industry": {
                    "type": "keyword"
                },
                "SmallIndustry": {
                    "type": "keyword"
                },
                "Month": {
                    "type": "integer"
                },
                "Year": {
                    "type": "integer"
                }
            }
        }
    },
    "settings": {
        "number_of_shards": 4,
        "number_of_replicas": 1
    }
}

POST /_aliases
{
  "actions": [
    {
      "add": {
        "index": "jobui_salary_search_2022_v2",
        "alias": "jobui_salary_search"
      }
    }
  ]
}
```

分析关键字	

```shell
POST /_analyze
{
    "analyzer": "ik_max_word",
    "text": "C++开发、 C++专家"
}
```



